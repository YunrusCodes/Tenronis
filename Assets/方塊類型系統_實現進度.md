# æ–¹å¡Šé¡å‹ç³»çµ±å¯¦ç¾é€²åº¦

## âœ… å·²å®Œæˆ

### 1. æ·»åŠ  BlockType æšèˆ‰
- âœ… åœ¨ `GameEnums.cs` ä¸­æ·»åŠ äº† `BlockType` æšèˆ‰
  - `Normal`: æ™®é€šæ–¹å¡Š
  - `Void`: è™›ç„¡æ–¹å¡Šï¼ˆåƒåœ¾è¡Œï¼‰
  - `Explosive`: çˆ†ç‚¸æ–¹å¡Šï¼ˆ8-10é—œï¼‰

### 2. ä¿®æ”¹ BlockData çµæ§‹
- âœ… åœ¨ `BlockData.cs` ä¸­æ·»åŠ äº† `blockType` å­—æ®µ
- âœ… æ›´æ–°äº†æ§‹é€ å‡½æ•¸å’Œ Clone æ–¹æ³•

### 3. ç©å®¶æ–¹å¡Šè¨­ç½®
- âœ… `TetrominoController.MergePieceToGrid()` - ç©å®¶æ”¾ç½®çš„æ–¹å¡Šç‚º `BlockType.Normal`

### 4. æ•µäººæ–¹å¡Šè¨­ç½®
- âœ… `CombatManager.ProcessBulletHitGrid()` - AddBlock æ ¹æ“šé—œå¡ç”Ÿæˆ `Explosive` æˆ– `Normal`
  - é—œå¡ 8ã€9ã€10ï¼ˆç´¢å¼• 7+ï¼‰ç”Ÿæˆ `Explosive`
  - å…¶ä»–é—œå¡ç”Ÿæˆ `Normal`
- âœ… `GridManager.InsertIndestructibleRow()` - çµ‚ç„‰æ©Ÿæ¢°ç¥æ’å…¥çš„ç‚º `BlockType.Void`

### 5. æ¶ˆé™¤é‚è¼¯å„ªåŒ–
- âœ… `GridManager.CheckAndClearRows()` - æª¢æ¸¬æ˜¯å¦åŒ…å« Void æ–¹å¡Š
- âœ… `GridManager.ClearRows()` - æ¥å— `hasVoidBlocks` åƒæ•¸

## âœ… å…¨éƒ¨å®Œæˆï¼

æ‰€æœ‰åŠŸèƒ½å·²å¯¦ç¾å®Œç•¢ï¼

## ~~â³ å¾…å®Œæˆ~~ï¼ˆå·²å®Œæˆï¼‰

### 1. ä¿®æ”¹äº‹ä»¶ç³»çµ±
éœ€è¦ä¿®æ”¹ `GameEvents.cs`:

```csharp
// ä¿®æ”¹äº‹ä»¶ç°½å
public static event Action<int, bool> OnRowsCleared; // è¡Œæ•¸, æ˜¯å¦å«è™›ç„¡

// ä¿®æ”¹è§¸ç™¼æ–¹æ³•
public static void TriggerRowsCleared(int count, bool hasVoid = false) 
    => OnRowsCleared?.Invoke(count, hasVoid);
```

### 2. æ›´æ–°æ‰€æœ‰è¨‚é–±è€…
éœ€è¦ä¿®æ”¹æ‰€æœ‰è¨‚é–± `OnRowsCleared` çš„åœ°æ–¹:

#### PlayerManager.cs
```csharp
private void HandleRowsCleared(int rowCount, bool hasVoid)
{
    if (rowCount > 0)
    {
        // å¢åŠ Combo
        stats.comboCount++;
        GameEvents.TriggerComboChanged(stats.comboCount);
        
        // å–æ¶ˆComboé‡ç½®
        comboResetPending = false;
        
        // å¢åŠ åˆ†æ•¸
        AddScore(rowCount * 100);
        
        // âœ¨ æ–°å¢ï¼šæª¢æŸ¥æ˜¯å¦ç‚ºè™›ç„¡æŠµéŠ·
        if (hasVoid)
        {
            Debug.Log("[PlayerManager] è™›ç„¡æŠµéŠ·ï¼ä¸ç”¢ç”Ÿå°å½ˆ");
            // é¡¯ç¤ºç‰¹æ®Šæ–‡å­—ï¼ˆå³ä½¿é½Šå°„ç‚º1ä¹Ÿé¡¯ç¤ºï¼‰
            GameEvents.TriggerShowPopupText(
                "è™›ç„¡æŠµéŠ·!",
                Color.gray,
                Vector2.zero
            );
        }
    }
}
```

#### GameUI.cs
```csharp
private void HandleRowsClearedForSalvo(int rowCount, bool hasVoid)
{
    if (rowCount <= 0) return;
    
    // âœ¨ æ–°å¢ï¼šè™›ç„¡æŠµéŠ·é¡¯ç¤º
    if (hasVoid)
    {
        if (salvoText != null)
        {
            salvoText.text = "è™›ç„¡æŠµéŠ·!";
            salvoText.color = Color.gray;
            StartCoroutine(HideSalvoTextAfterDelay(2f));
        }
        return; // ä¸é¡¯ç¤ºé½Šå°„æ–‡å­—
    }
    
    // åŸæœ‰çš„é½Šå°„é¡¯ç¤ºé‚è¼¯...
    if (rowCount >= 2)
    {
        // ... åŸæœ‰ä»£ç¢¼ ...
    }
}
```

#### CombatManager.cs
```csharp
private void CheckRowsAfterAddBlock()
{
    if (GridManager.Instance == null) return;
    
    List<int> clearedRows = GridManager.Instance.CheckAndClearRows();
    
    if (clearedRows.Count > 0)
    {
        Debug.Log($"[CombatManager] æ•µäººæ·»åŠ æ–¹å¡Šå½¢æˆå®Œæ•´è¡Œï¼æ¶ˆé™¤äº† {clearedRows.Count} è¡Œ");
        
        // âš ï¸ éœ€è¦å¾ GridManager ç²å– hasVoid ä¿¡æ¯
        // ç›®å‰ CheckAndClearRows è¿”å› List<int>ï¼Œéœ€è¦ä¿®æ”¹ç‚ºè¿”å› (List<int>, bool)
        // æˆ–è€…åœ¨ GridManager ä¸­æ·»åŠ ä¸€å€‹å±¬æ€§ä¾†å­˜å„²æœ€å¾Œä¸€æ¬¡æ¶ˆé™¤æ˜¯å¦åŒ…å« Void
        
        GameEvents.TriggerRowsCleared(clearedRows.Count);
    }
}
```

### 3. å¯¦ç¾çˆ†ç‚¸æ–¹å¡Šå‚·å®³
åœ¨ `GridManager.cs` çš„ `DamageBlock()` æ–¹æ³•ä¸­:

```csharp
public void DamageBlock(int x, int y, int damage)
{
    if (!IsValidPosition(x, y)) return;
    
    BlockData block = grid[y, x];
    if (block == null) return;
    
    // å¦‚æœæ˜¯ä¸å¯æ‘§æ¯€æ–¹å¡Šï¼Œç›´æ¥è¿”å›
    if (block.isIndestructible) return;
    
    // æ¸›å°‘HP
    block.hp -= damage;
    
    // âœ¨ æ–°å¢ï¼šå¦‚æœæ˜¯çˆ†ç‚¸æ–¹å¡Šä¸”è¢«æ‘§æ¯€
    if (block.hp <= 0 && block.blockType == BlockType.Explosive)
    {
        Debug.Log($"[GridManager] çˆ†ç‚¸æ–¹å¡Šåœ¨ ({x}, {y}) è¢«æ‘§æ¯€ï¼ç©å®¶å—åˆ° 5 é»å‚·å®³");
        GameEvents.TriggerPlayerDamaged(5);
    }
    
    // å¦‚æœHPæ­¸é›¶ï¼Œç§»é™¤æ–¹å¡Š
    if (block.hp <= 0)
    {
        RemoveBlock(x, y);
    }
    else
    {
        // æ›´æ–°è¦–è¦º
        UpdateBlockVisual(x, y);
    }
}
```

### 4. ä¿®æ”¹å°å½ˆç™¼å°„é‚è¼¯
åœ¨ `CombatManager.cs` ä¸­ï¼Œç™¼å°„å°å½ˆå‰æª¢æŸ¥æ˜¯å¦ç‚ºè™›ç„¡æŠµéŠ·:

```csharp
// åœ¨ç™¼å°„å°å½ˆçš„åœ°æ–¹ï¼ˆå¯èƒ½åœ¨ PlayerManager æˆ– CombatManager ä¸­ï¼‰
private void HandleRowsCleared(int rowCount, bool hasVoid)
{
    if (hasVoid)
    {
        // è™›ç„¡æŠµéŠ·ï¼šä¸ç™¼å°„å°å½ˆ
        Debug.Log("[CombatManager] è™›ç„¡æŠµéŠ·ï¼Œå–æ¶ˆå°å½ˆç™¼å°„");
        return;
    }
    
    // è¨ˆç®—å°å½ˆæ•¸é‡
    int missileCount = CalculateMissileCount(rowCount);
    
    // ç™¼å°„å°å½ˆ
    for (int i = 0; i < missileCount; i++)
    {
        FireMissile();
    }
}
```

## ğŸ“‹ éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶æ¸…å–®

1. âœ… `Assets/Scripts/Data/GameEnums.cs` - æ·»åŠ  BlockType
2. âœ… `Assets/Scripts/Data/BlockData.cs` - æ·»åŠ  blockType å­—æ®µ
3. âœ… `Assets/Scripts/Gameplay/Tetromino/TetrominoController.cs` - Normal é¡å‹
4. âœ… `Assets/Scripts/Managers/GridManager.cs` - Void æª¢æ¸¬å’Œ ClearRows
5. âœ… `Assets/Scripts/Managers/CombatManager.cs` - Explosive ç”Ÿæˆ
6. â³ `Assets/Scripts/Core/GameEvents.cs` - äº‹ä»¶ç°½å
7. â³ `Assets/Scripts/Managers/PlayerManager.cs` - è™›ç„¡æŠµéŠ·è™•ç†
8. â³ `Assets/Scripts/UI/GameUI.cs` - è™›ç„¡æŠµéŠ· UI
9. â³ `Assets/Scripts/Managers/GridManager.cs` - çˆ†ç‚¸å‚·å®³
10. â³ `Assets/Scripts/Managers/CombatManager.cs` - å°å½ˆç™¼å°„é‚è¼¯

## ğŸ¯ åŠŸèƒ½ç¸½çµ

### Normalï¼ˆæ™®é€šæ–¹å¡Šï¼‰
- ç©å®¶æ”¾ç½®çš„æ–¹å¡Š
- ç„¡ç‰¹æ®Šæ•ˆæœ
- æ¶ˆé™¤æ™‚æ­£å¸¸ç”¢ç”Ÿå°å½ˆ

### Voidï¼ˆè™›ç„¡æ–¹å¡Šï¼‰
- çµ‚ç„‰æ©Ÿæ¢°ç¥ï¼ˆé—œå¡ 10ï¼‰æ’å…¥çš„åƒåœ¾è¡Œ
- æ¶ˆé™¤æ™‚**ä¸ç”¢ç”Ÿå°å½ˆ**
- é¡¯ç¤º"è™›ç„¡æŠµéŠ·!"è€Œé"é½Šå°„ xN"
- å³ä½¿åªæœ‰ 1 æ’ä¹Ÿæœƒé¡¯ç¤ºæç¤º

### Explosiveï¼ˆçˆ†ç‚¸æ–¹å¡Šï¼‰
- é—œå¡ 8ã€9ã€10 æ•µäºº AddBlock ç”Ÿæˆçš„æ–¹å¡Š
- è¢«æ•µæ–¹å°„æ“Šç ´å£æ™‚ï¼Œç©å®¶å—åˆ° **5 é»å‚·å®³**
- ç©å®¶ä¸»å‹•æ¶ˆé™¤ï¼ˆæ¶ˆè¡Œï¼‰ä¸æœƒè§¸ç™¼çˆ†ç‚¸
- åªæœ‰è¢«æ•µäººå­å½ˆæ‘§æ¯€æ‰çˆ†ç‚¸

## ğŸ§ª æ¸¬è©¦è¦é»

1. **Normal æ–¹å¡Š**: 
   - ç©å®¶æ”¾ç½®æ–¹å¡Š
   - æ¶ˆé™¤æ™‚æ­£å¸¸ç™¼å°„å°å½ˆ

2. **Void æ–¹å¡Š**:
   - é—œå¡ 10 çµ‚ç„‰æ©Ÿæ¢°ç¥æ’å…¥è¡Œ
   - æ¶ˆé™¤æ™‚é¡¯ç¤º"è™›ç„¡æŠµéŠ·!"
   - ä¸ç™¼å°„å°å½ˆ

3. **Explosive æ–¹å¡Š**:
   - é—œå¡ 8-10 æ•µäºº AddBlock ç”Ÿæˆ
   - è¢«æ•µäººå­å½ˆç ´å£æ™‚ç©å®¶ -5 HP
   - ç©å®¶æ¶ˆè¡Œæ™‚ä¸çˆ†ç‚¸

---

## ğŸ“ ç›¸é—œç³»çµ±æ›´æ–°ï¼ˆ2025å¹´ï¼‰

### Buffå’ŒæŠ€èƒ½ç³»çµ±æ”¹å‹•
- âœ… Buffåç¨±æ›´æ–°ï¼šé€£ç™¼åŠ é€Ÿå™¨â†’é€£ç™¼å¼·åŒ–ï¼Œå¤šé‡é½Šå°„â†’é½Šå°„å¼·åŒ–ï¼Œåæ“Šç³»çµ±â†’åæ“Šå¼·åŒ–
- âœ… æ–°å¢è³‡æºæ“´å……Buffï¼šå¢åŠ CPä¸Šé™ï¼ˆæ¯æ¬¡+50ï¼Œæœ€é«˜ç­‰ç´š3ï¼‰
- âœ… Executionå’ŒRepairæ”¹ç‚ºæ¶ˆè€—CPçš„æŠ€èƒ½ï¼ˆ5 CPå’Œ30 CPï¼‰
- âœ… æ·»åŠ CPè®ŠåŒ–äº‹ä»¶ç³»çµ±ï¼ˆ`OnCpChanged`ï¼‰
- âœ… æº¢å‡ºå‚·å®³æ©Ÿåˆ¶æ”¹å‹•ï¼š
  - åæ“Šä¸€æ¬¡å¢åŠ 5å……èƒ½
  - æ¶ˆæ’ä¸€æ¬¡å¢åŠ 50å……èƒ½
  - èµ·å§‹å……èƒ½ä¸Šé™ç‚º200
  - Explosion Buffæ”¹ç‚ºå¢åŠ 200å……èƒ½ä¸Šé™ï¼Œæœ€é«˜ç­‰ç´š4ï¼ˆæœ€å¤š1000ï¼‰
- âœ… å¼·åŒ–ç­‰ç´šè¦æ ¼èª¿æ•´ï¼š
  - Defenseï¼šèµ·å§‹0ï¼Œç„¡ä¸Šé™
  - Volleyï¼šèµ·å§‹1ï¼Œä¸Šé™6
  - Explosionï¼šèµ·å§‹1ï¼Œä¸Šé™4
  - Salvoï¼šèµ·å§‹0ï¼Œç„¡ä¸Šé™
  - Burstï¼šèµ·å§‹1ï¼Œä¸Šé™6
  - Counterï¼šèµ·å§‹1ï¼Œä¸Šé™6
  - SpaceExpansionï¼šèµ·å§‹1ï¼Œä¸Šé™4
  - ResourceExpansionï¼šèµ·å§‹0ï¼Œä¸Šé™3
- âœ… UIé¡¯ç¤ºå„ªåŒ–ï¼š
  - æ¯è¡Œé¡¯ç¤º3å€‹å¼·åŒ–
  - æ–°å¢LegendaryBuffTextï¼Œè£ç”²å¼·åŒ–å’Œå”åŒç«åŠ›å–®ç¨é¡¯ç¤º
  - ç§»é™¤emojiåœ–æ¨™
- âœ… GameManageræ”¹å‹•ï¼š
  - å°‡ `availableBuffs` æ‹†åˆ†ç‚º `normalBuffs` å’Œ `legendaryBuffs` å…©å€‹é™£åˆ—
  - æ™®é€šå¼·åŒ–ï¼šSalvo, Burst, Counter, Explosion, SpaceExpansion, ResourceExpansion
  - å‚³å¥‡å¼·åŒ–ï¼šDefense, Volley, Heal
- âœ… å‚³å¥‡å¼·åŒ–é¸æ“‡æ©Ÿåˆ¶ï¼š
  - ç•¶æœ‰æ™®é€šå¼·åŒ–é”åˆ°æ»¿ç´šæ™‚ï¼Œæœƒè‡ªå‹•æä¾›å‚³å¥‡å¼·åŒ–é¸æ“‡æ©Ÿæœƒ
  - å‚³å¥‡å¼·åŒ–é¸æ“‡æ™‚ï¼Œåªå¾ Legendary Buffs é™£åˆ—ä¸­é¸æ“‡
  - å¦‚æœå‚³å¥‡å¼·åŒ–æ•¸é‡ â‰¤ 3ï¼Œç›´æ¥é¡¯ç¤ºå…¨éƒ¨ï¼ˆä¸éš¨æ©Ÿé¸æ“‡ï¼‰
  - å¦‚æœå‚³å¥‡å¼·åŒ–æ•¸é‡ > 3ï¼Œéš¨æ©Ÿé¸æ“‡3å€‹ï¼ˆæ ¹æ“šæ¬Šé‡ï¼‰
  - ä¸æœƒéæ¿¾å‚³å¥‡å¼·åŒ–ï¼ˆé™¤äº†nullï¼‰ï¼Œä¿ç•™æ‰€æœ‰å…§å®¹
  - ç•¶é¸æ“‡æœ€å¾Œä¸€å€‹æ™®é€šå¼·åŒ–ä½¿å…¶é”åˆ°æ»¿ç´šæ™‚ï¼Œæœƒç«‹å³æä¾›å‚³å¥‡å¼·åŒ–é¸æ“‡æ©Ÿæœƒ


