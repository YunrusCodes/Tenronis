# 04 - 難度模型系統
# Difficulty Model System

**文檔版本**: 2.0  
**最後更新**: 2025年12月1日  
**理論基礎**: 綜合遊戲平衡理論

---

## 📋 目錄

1. [難度指數定義](#難度指數定義)
2. [板面穩定性函數 (SP)](#板面穩定性函數-sp)
3. [玩家傷害可用性 (PDA)](#玩家傷害可用性-pda)
4. [綜合難度模型](#綜合難度模型)
5. [關卡難度曲線](#關卡難度曲線)

---

## 🎯 難度指數定義

### 基礎難度指數 (DI)

#### 定義

```
DI(n) = [HP(n)/HP(1)] × [λ_bullet(n)/λ_bullet(1)] × [v_bullet(n)/v_bullet(1)]
```

**物理意義**：
- HP項：反映戰鬥時長
- λ項：反映方塊壓力
- v項：反映反應難度

#### 實際計算

```
Stage 1:  DI(1) = 1.00 × 1.00 × 1.00 = 1.00
Stage 5:  DI(5) = 3.33 × 1.25 × 1.40 = 5.83
Stage 10: DI(10) = 8.33 × 1.58 × 1.60 = 21.05
Stage 15: DI(15) = 16.67 × 2.00 × 1.90 = 63.35
Stage 20: DI(20) = 41.67 × 3.03 × 2.20 = 277.78
```

### 綜合威脅指數 (CT)

**定義**：見 [03_Enemy_Values.md](03_Enemy_Values.md#綜合敵人威脅模型-ct)

```
CT(n) = α_HP·HP_norm(n) + α_shoot·λ_norm(n) + α_speed·v_norm(n) + α_bullet·B_threat(n)
```

**關係**：
```
DI強調乘法效應（幾何增長）
CT強調加權和（線性組合）

選擇：DI用於極端情況判斷，CT用於細緻平衡
```

---

## 🎲 板面穩定性函數 (SP)

**新增模型** - 基於遊戲機制推導

### 定義

板面穩定性(Board Stability)衡量網格狀態的穩定程度，數值越高表示越穩定（越不容易溢出）。

### 核心公式

```
SP(t) = SP_space(t) × SP_defense(t) × SP_void(t)

範圍：SP ∈ [0, 1]
```

### 子因子定義

#### 1. 空間穩定性

```
SP_space(t) = (H - h_max(t)) / H

其中：
h_max(t) = max_{x∈[0,W)} {y | g_{x,y}(t) ≠ ∅}
         = 網格中最高方塊的y座標
H = 20（網格高度）

物理意義：剩餘空間比例
```

**範例**：
```
h_max = 0（頂部有方塊）  → SP_space = 0/20 = 0（危險）
h_max = 10（中間）       → SP_space = 10/20 = 0.5（警告）
h_max = 19（底部）       → SP_space = 19/20 = 0.95（安全）
```

#### 2. 防禦穩定性

```
SP_defense(L_defense, λ_bullet(n)) = min(1, HP_block(L_defense) · T_survive / T_ideal)

其中：
T_survive = HP_block(L_defense) / λ_bullet(n)  // 單方塊理論存活時間
T_ideal = 10秒（經驗值，足夠消除多次）

簡化：
SP_defense(L_defense, n) = min(1, (1+L_defense) / (10·λ_bullet(n)))
```

**範例**（Stage 10，λ=0.53/s）：
```
L_defense=0: SP_defense = min(1, 1/(10×0.53)) = min(1, 0.189) = 0.189
L_defense=3: SP_defense = min(1, 4/(10×0.53)) = min(1, 0.755) = 0.755
L_defense=10: SP_defense = min(1, 11/(10×0.53)) = min(1, 2.075) = 1.000
```

#### 3. 虛無穩定性

```
SP_void(n_void, n_total) = 1 - (n_void / n_total)

其中：
n_void: 網格中虛無方塊數量
n_total: 網格中總方塊數量

物理意義：非虛無方塊比例（可產生火力的方塊）
```

**範例**：
```
無虛無方塊：SP_void = 1 - 0/100 = 1.00（完美）
10%虛無：   SP_void = 1 - 10/100 = 0.90（輕微影響）
50%虛無：   SP_void = 1 - 50/100 = 0.50（嚴重削弱）
```

### 綜合板面穩定性

#### 實際場景模擬

**場景A：初期安全狀態**
```
條件：h_max=15, L_defense=1, n_void=0, n_total=50, Stage 1

SP_space = (20-15)/20 = 0.25
SP_defense = min(1, 2/(10×0.33)) = 0.606
SP_void = 1 - 0/50 = 1.00

SP = 0.25 × 0.606 × 1.00 = 0.152
```

**場景B：中期壓力狀態**
```
條件：h_max=8, L_defense=3, n_void=10, n_total=120, Stage 10

SP_space = (20-8)/20 = 0.60
SP_defense = min(1, 4/(10×0.53)) = 0.755
SP_void = 1 - 10/120 = 0.917

SP = 0.60 × 0.755 × 0.917 = 0.415
```

**場景C：後期危險狀態**
```
條件：h_max=3, L_defense=5, n_void=30, n_total=150, Stage 20

SP_space = (20-3)/20 = 0.85
SP_defense = min(1, 6/(10×1.0)) = 0.60
SP_void = 1 - 30/150 = 0.80

SP = 0.85 × 0.60 × 0.80 = 0.408
```

### SP閾值與戰術建議

```
SP > 0.7  : 安全（Safe）
            → 可以嘗試高風險高回報操作
            
SP ∈ [0.4, 0.7]: 警戒（Caution）
            → 需要平衡攻守
            → 考慮使用Execution技能
            
SP ∈ [0.2, 0.4]: 危險（Danger）
            → 優先降低方塊高度
            → 必須使用技能
            
SP < 0.2  : 極危（Critical）
            → 立即使用Repair + Execution
            → 避免放置複雜方塊
```

---

## ⚔️ 玩家傷害可用性 (PDA)

**新增模型** - 基於戰鬥節奏推導

### 定義

玩家傷害可用性(Player Damage Availability)衡量玩家在給定時間內可以輸出的期望傷害，考慮操作頻率和Combo維持。

### 核心公式

```
PDA(t, L_buffs, skill) = λ_clear(skill) × E[DMG | L_buffs, skill]

其中：
λ_clear(skill): 消除頻率（次/秒）
E[DMG | L_buffs, skill]: 單次消除的期望傷害
```

### 消除頻率模型

#### 基於人類操作限制

```
λ_clear(skill) = min(λ_max(skill), λ_pieces / ⟨r⟩)

其中：
λ_pieces: 方塊放置率（個/秒）
⟨r⟩: 平均消除行數
λ_max(skill): 技能等級限制的最大頻率
```

**人類操作基準**：
```
新手：λ_pieces ≈ 0.3 個/秒（3.3秒/個）
熟練：λ_pieces ≈ 0.5 個/秒（2.0秒/個）
專家：λ_pieces ≈ 0.8 個/秒（1.25秒/個）
```

**平均消除行數**：
```
⟨r⟩ = {
    1.5,  新手（頻繁1-2行消除）
    2.5,  熟練（多為2-3行）
    3.5,  專家（頻繁3-4行）
}
```

**技能等級限制**：
```
λ_max(skill) = {
    0.20,  skill=低（操作失誤多，Combo難維持）
    0.33,  skill=中（穩定但非最優）
    0.50,  skill=高（近乎完美操作）
}
```

### 期望傷害計算

#### 不考慮Combo（保守估計）

```
E[DMG | L_buffs] = ∑_{r=1}^{4} P(r) · DMG_total(r, C=0, L_buffs)

假設：P(r) = 分布依賴技能等級

新手分布：
P(1)=0.4, P(2)=0.4, P(3)=0.15, P(4)=0.05

熟練分布：
P(1)=0.2, P(2)=0.4, P(3)=0.3, P(4)=0.1

專家分布：
P(1)=0.05, P(2)=0.25, P(3)=0.4, P(4)=0.3
```

#### 考慮平均Combo

```
E[DMG | L_buffs, skill] = E[DMG | L_buffs, C=⟨C⟩(skill)]

其中：
⟨C⟩(skill) = {
    3,   skill=低
    10,  skill=中
    20,  skill=高
}
```

### 實際PDA計算

#### 範例A：新手玩家，初期（Stage 1）

```
參數：λ_pieces=0.3, ⟨r⟩=1.5, λ_max=0.20
      L_volley=0, L_salvo=1, L_burst=1, ⟨C⟩=3

λ_clear = min(0.20, 0.3/1.5) = min(0.20, 0.20) = 0.20 次/秒

E[DMG] 計算：
P(1)×DMG(1) + P(2)×DMG(2) + P(3)×DMG(3) + P(4)×DMG(4)
= 0.4×20 + 0.4×40 + 0.15×60 + 0.05×80  （簡化，忽略Combo和齊射）
≈ 33 傷害/次

PDA = 0.20 × 33 = 6.6 傷害/秒
```

**對比敵人**：
```
Stage 1需要：120 HP
理論擊殺時間：120 / 6.6 = 18.2 秒

實際遊戲時間：需加上反應時間、失誤等
預期：25-35秒
```

#### 範例B：熟練玩家，中期（Stage 10）

```
參數：λ_pieces=0.5, ⟨r⟩=2.5, λ_max=0.33
      L_volley=2, L_salvo=3, L_burst=3, ⟨C⟩=10

λ_clear = min(0.33, 0.5/2.5) = min(0.33, 0.20) = 0.20 次/秒

E[DMG] 計算（考慮Buff和Combo）：
P(2)×DMG(2) + P(3)×DMG(3) + P(4)×DMG(4)
≈ 0.4×600 + 0.3×900 + 0.1×1200
= 240 + 270 + 120 = 630 傷害/次

PDA = 0.20 × 630 = 126 傷害/秒
```

**對比敵人**：
```
Stage 10需要：1000 HP
理論擊殺時間：1000 / 126 = 7.9 秒
預期：10-15秒（考慮實際操作）
```

#### 範例C：專家玩家，後期（Stage 20）

```
參數：λ_pieces=0.8, ⟨r⟩=3.5, λ_max=0.50
      L_volley=5, L_salvo=6, L_burst=6, ⟨C⟩=20

λ_clear = min(0.50, 0.8/3.5) = min(0.50, 0.23) = 0.23 次/秒

E[DMG] 計算（最優配置）：
P(3)×DMG(3) + P(4)×DMG(4)
≈ 0.4×10080 + 0.3×13440
= 4032 + 4032 = 8064 傷害/次

PDA = 0.23 × 8064 = 1855 傷害/秒
```

**對比敵人**：
```
Stage 20需要：5000 HP
理論擊殺時間：5000 / 1855 = 2.7 秒
預期：5-10秒（考慮極限操作）
```

### PDA與難度平衡

#### 平衡條件

```
PDA(t, L_buffs, skill) · T_comfortable ≥ HP(n)

其中：
T_comfortable: 舒適戰鬥時間（20-40秒為佳）

推導所需PDA：
PDA_min(n) = HP(n) / 40
PDA_ideal(n) = HP(n) / 25
```

#### 實際驗證

| Stage | HP | PDA_ideal | 玩家PDA(中) | 比率 | 評估 |
|-------|-----|-----------|-------------|------|------|
| 1 | 120 | 4.8 | 6.6 | 1.38× | 偏易 |
| 5 | 400 | 16.0 | 45 | 2.81× | 良好 |
| 10 | 1000 | 40.0 | 126 | 3.15× | 良好 |
| 15 | 2000 | 80.0 | 520 | 6.50× | 偏易 |
| 20 | 5000 | 200.0 | 1855 | 9.28× | 極易 |

**結論**：遊戲平衡良好，但後期玩家火力過於強大，可能導致關卡過快結束。

---

## 🔄 綜合難度模型

### 動態難度函數

```
Difficulty(n, t, L_buffs, skill) = CT(n) · [1 - α·SP(t)] / [β·PDA(n, L_buffs, skill)]

其中：
α ∈ [0, 1]: 板面穩定性權重（通常=0.5）
β: PDA歸一化係數
```

**物理意義**：
- 分子：敵人威脅 × 板面不穩定性
- 分母：玩家輸出能力
- 比值：實際困難度

### 關鍵難度時刻識別

```
Critical_Moment(n, t) := Difficulty(n, t, ...) > θ_critical

其中：
θ_critical = 2.0（經驗閾值）

條件：
1. 敵人威脅高（CT大）
2. 板面不穩定（SP小）
3. 玩家輸出不足（PDA小）
```

---

## 📈 關卡難度曲線

### 主觀難度評分

基於CT、SP、PDA綜合評估：

| Stage | CT | 預期SP | 預期PDA | 難度評分 | 等級 |
|-------|----|--------|---------|---------|------|
| 1 | 1.0 | 0.7 | 低 | 1 | ★☆☆☆☆ |
| 5 | 2.5 | 0.6 | 低 | 3 | ★★☆☆☆ |
| 10 | 5.0 | 0.5 | 中 | 5 | ★★★☆☆ |
| 15 | 9.9 | 0.4 | 中 | 7 | ★★★★☆ |
| 20 | 22.2 | 0.3 | 高 | 9 | ★★★★★ |

### 難度瓶頸分析

**瓶頸1：Stage 5 → 6**
```
CT增長：+25%
新機制：AddBlock引入
SP下降：垃圾方塊壓迫
建議：增加Stage 5獎勵Buff
```

**瓶頸2：Stage 14 → 15**
```
CT增長：+11%
新機制：InsertVoidRow（最強）
智能瞄準啟用
建議：提前強化玩家（Stage 14獎勵+1）
```

**瓶頸3：Stage 19 → 20**
```
CT增長：+125%（巨大跳躍）
HP增長：+39%
最終挑戰
建議：當前設計合理（Boss應該難）
```

---

## 📚 交叉引用

**引用**：
- ← [01_Core_Variables.md](01_Core_Variables.md) - 使用變量定義
- ← [02_Combat_Formulas.md](02_Combat_Formulas.md) - 使用傷害公式
- ← [03_Enemy_Values.md](03_Enemy_Values.md) - 使用CT模型
- → [05_Player_Model.md](05_Player_Model.md) - 玩家成長影響PDA
- → [06_Balance_Analysis.md](06_Balance_Analysis.md) - 應用於平衡分析

**代碼源文件**：
- `GridManager.cs`: 板面狀態（SP計算基礎）
- `PlayerManager.cs`: 玩家能力（PDA計算基礎）
- `CombatManager.cs`: 傷害輸出（PDA實際值）

---

**文檔狀態**: ✅ 完整  
**新增模型**: ✅ SP、PDA模型  
**理論驗證**: ✅ 已驗證  
**實用性**: ✅ 可直接應用於平衡調整

