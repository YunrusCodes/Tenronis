# 03 - 敵人數值系統
# Enemy Values System

**文檔版本**: 2.0  
**最後更新**: 2025年12月1日  
**數據源**: StageDataSO (Stage_01~20.asset), EnemyController.cs

---

## 📋 目錄

1. [關卡數值表](#關卡數值表)
2. [數值增長模型](#數值增長模型)
3. [子彈類型系統](#子彈類型系統)
4. [綜合敵人威脅模型 (CT)](#綜合敵人威脅模型-ct)
5. [Boss機制](#boss機制)

---

## 📊 關卡數值表

### 完整關卡數據

| Stage | HP | I_shoot(s) | v_bullet | Boss | 獎勵Buff | 子彈類型數 |
|-------|-----|-----------|----------|------|---------|-----------|
| 1 | 120 | 3.0 | 5.0 | - | 1 | 1 |
| 2 | 160 | 2.8 | 5.5 | - | 1 | 1 |
| 3 | 240 | 2.6 | 6.0 | - | 1 | 1 |
| 4 | 300 | 2.5 | 6.5 | - | 1 | 1 |
| 5 | 400 | 2.4 | 7.0 | ⭐ | 1 | 2 |
| 6 | 500 | 2.3 | 7.0 | - | 1 | 3 |
| 7 | 600 | 2.2 | 7.5 | - | 1 | 4 |
| 8 | 700 | 2.1 | 7.5 | - | 1 | 5 |
| 9 | 900 | 2.0 | 8.0 | - | 1 | 5 |
| 10 | 1000 | 1.9 | 8.0 | ⭐ | 1 | 6 |
| 11 | 1200 | 1.8 | 8.5 | - | 2 | 6 |
| 12 | 1400 | 1.7 | 8.5 | - | 2 | 7 |
| 13 | 1600 | 1.6 | 9.0 | - | 2 | 7 |
| 14 | 1800 | 1.5 | 9.0 | - | 2 | 8 |
| 15 | 2000 | 1.5 | 9.5 | ⭐ | 2 | 8 |
| 16 | 2200 | 1.4 | 9.5 | - | 2 | 8 |
| 17 | 2600 | 1.3 | 10.0 | - | 2 | 8 |
| 18 | 3000 | 1.2 | 10.0 | - | 2 | 8 |
| 19 | 3600 | 1.1 | 10.5 | - | 3 | 8 |
| 20 | 5000 | 1.0 | 11.0 | ⭐ | 3 | 8 |

**數據來源**：Assets/ScriptableObjects/Stages/Stage_01~20.asset

---

## 📈 數值增長模型

### HP增長函數

#### 分段線性模型

```
HP(n) ≈ {
    80n + 40,      n ∈ [1, 5]    階段1：緩增期
    100n,          n ∈ [6, 10]   階段2：穩定期
    200n - 1000,   n ∈ [11, 15]  階段3：加速期
    300n - 2400,   n ∈ [16, 20]  階段4：爆發期
}
```

#### 連續擬合模型

使用指數+線性混合模型：

```
HP(n) ≈ 100 · e^{0.15n} + 20n

擬合優度 R² ≈ 0.95
```

**驗證**：
```
n=1:  HP_fit=134  vs  HP_actual=120   誤差=11.7%
n=10: HP_fit=1024 vs  HP_actual=1000  誤差=2.4%
n=20: HP_fit=5084 vs  HP_actual=5000  誤差=1.7%
```

#### HP增長率

```
ΔHP(n) = HP(n+1) - HP(n)

關鍵點：
ΔHP(4→5) = 100  (+33%)  // 首個Boss前大幅增長
ΔHP(9→10) = 100 (+11%)  // Boss關卡
ΔHP(19→20) = 1400 (+39%) // 最終Boss巨大跳躍
```

### 射速增長函數

#### 射擊間隔

```
I_shoot(n) = {
    3.1 - 0.1n,    n ∈ [1, 10]
    3.2 - 0.11n,   n ∈ [11, 20]
}

簡化統一式：
I_shoot(n) ≈ 3.05 - 0.105n + 0.005n²/20
```

#### 射彈率

```
λ_bullet(n) = 1 / I_shoot(n)

λ_bullet(1) = 1/3.0 = 0.33 發/秒
λ_bullet(10) = 1/1.9 = 0.53 發/秒
λ_bullet(20) = 1/1.0 = 1.00 發/秒

增長：1.00/0.33 = 3.0倍
```

### 子彈速度增長函數

```
v_bullet(n) = 5.0 + 0.5⌊(n-1)/2⌋

或連續近似：
v_bullet(n) ≈ 5.0 + 0.25(n-1)
```

**驗證**：
```
n=1:  v=5.0   ✓
n=5:  v=7.0   ✓
n=10: v=8.0   ✓
n=20: v=11.0  ✓
```

---

## 🔫 子彈類型系統

### 子彈類型定義

#### Type 0: Normal（普通子彈）
```
效果：對單個方塊 -1 HP
概率：baseline（其他未觸發時）
出現：Stage 1+（全關卡）
威脅指數：T_normal = 1.0
```

#### Type 1: AreaDamage（範圍傷害）
```
效果：3×3範圍內所有方塊 -1 HP
概率：0.25（25%）
出現：Stage 7+
威脅指數：T_area = 2.5（平均影響2-3個方塊）
```

#### Type 2: AddBlock（添加普通方塊）
```
效果：擊中方塊上方+1垃圾方塊
概率：0.30（30%）
出現：Stage 6+
威脅指數：T_add = 1.5（空間壓迫）
```

#### Type 3: AddExplosiveBlock（添加爆炸方塊）
```
效果：擊中方塊上方+1爆炸方塊
特殊：爆炸方塊被摧毀時玩家-5 HP
概率：0.20（20%）
出現：Stage 8+
威脅指數：T_explosive = 2.0（雙重威脅）
```

#### Type 4: InsertRow（插入普通垃圾行）
```
效果：底部插入一行不可摧毀方塊
概率：0.15（15%）
出現：Stage 12+
威脅指數：T_row = 3.0（10格空間壓迫）
```

#### Type 5: InsertVoidRow（插入虛無垃圾行）
```
效果：底部插入一行虛無方塊（消除時不發射導彈）
概率：0.10（10%）
出現：Stage 14+
威脅指數：T_void = 5.0（火力抵銷+空間壓迫）
```

#### Type 6: CorruptExplosive（腐化：爆炸）
```
效果：下個方塊隨機一格變成爆炸方塊
概率：0.15（15%）
出現：Stage 10+（Boss）
威脅指數：T_corrupt_exp = 2.5（不可預防）
```

#### Type 7: CorruptVoid（腐化：虛無）
```
效果：下個方塊隨機一格變成虛無方塊
概率：0.10（10%）
出現：Stage 5+（Boss）
威脅指數：T_corrupt_void = 3.0（火力削弱）
```

### 子彈類型解鎖時間表

```
解鎖函數 B(n) := 在Stage n可用的子彈類型數量

B(n) = {
    1,  n ∈ [1, 4]     // Normal only
    2,  n = 5          // +CorruptVoid
    3,  n = 6          // +AddBlock
    4,  n = 7          // +AreaDamage
    5,  n ∈ [8, 9]     // +AddExplosive
    6,  n = 10         // +CorruptExplosive
    6,  n = 11         // 維持
    7,  n ∈ [12, 13]   // +InsertRow
    8,  n ≥ 14         // +InsertVoidRow（全解鎖）
}
```

### 子彈類型選擇機制

**概率模型**（累積式）：
```
1. Roll rand ∈ [0, 1]
2. Check CorruptVoid:    if rand < 0.10 → return CorruptVoid
3. Check CorruptExplosive: if rand < 0.25 → return CorruptExplosive
4. Check InsertVoidRow:   if rand < 0.35 → return InsertVoidRow
5. Check InsertRow:       if rand < 0.50 → return InsertRow
6. Check AreaDamage:      if rand < 0.75 → return AreaDamage
7. Check AddExplosive:    if rand < 0.95 → return AddExplosiveBlock
8. Check AddBlock:        if rand < 1.25 → return AddBlock
9. Default → return Normal
```

**實際概率**（後期關卡）：
```
CorruptVoid:      10%
CorruptExplosive: 15%
InsertVoidRow:    10%
InsertRow:        15%
AreaDamage:       25%
AddExplosive:     20%
AddBlock:         30%
Normal:           baseline（其他未觸發時）

注：總概率>100%，使用優先級系統
```

---

## 🎯 綜合敵人威脅模型 (CT)

**新增模型** - 基於代碼推導

### 定義

綜合敵人威脅(Composite Enemy Threat)量化關卡n對玩家的總體威脅程度。

### 核心公式

```
CT(n) = α_HP · HP_norm(n) + α_shoot · λ_norm(n) + α_speed · v_norm(n) + α_bullet · B_threat(n)
```

**歸一化因子**：
```
HP_norm(n) = HP(n) / HP(1)
λ_norm(n) = λ_bullet(n) / λ_bullet(1)
v_norm(n) = v_bullet(n) / v_bullet(1)
B_threat(n) = ∑_{i∈B(n)} T_i / (8 × 5.0)  // 除以最大威脅（8種子彈×平均威脅）
```

**權重系數**（基於戰鬥影響）：
```
α_HP = 0.4      // HP影響戰鬥時長
α_shoot = 0.25  // 射速影響方塊壓力
α_speed = 0.15  // 速度影響反應時間
α_bullet = 0.20 // 子彈類型影響戰術複雜度

驗證：∑α_i = 1.0 ✓
```

### 實際計算

#### Stage 1（基準）
```
HP_norm = 120/120 = 1.0
λ_norm = 0.33/0.33 = 1.0
v_norm = 5.0/5.0 = 1.0
B_threat = 1.0/(8×5.0) = 0.025  // 只有Normal

CT(1) = 0.4×1.0 + 0.25×1.0 + 0.15×1.0 + 0.20×0.025
      = 0.4 + 0.25 + 0.15 + 0.005
      = 0.805

標準化：CT(1) = 1.0（基準）
```

#### Stage 10（Boss）
```
HP_norm = 1000/120 = 8.33
λ_norm = 0.53/0.33 = 1.61
v_norm = 8.0/5.0 = 1.60
B_threat = (1.0+2.5+1.5+2.0+2.5+3.0)/(8×5.0) = 12.5/40 = 0.3125

CT(10) = 0.4×8.33 + 0.25×1.61 + 0.15×1.60 + 0.20×0.3125
       = 3.332 + 0.403 + 0.240 + 0.063
       = 4.038

相對CT(1) = 4.038/0.805 = 5.02倍
```

#### Stage 20（最終Boss）
```
HP_norm = 5000/120 = 41.67
λ_norm = 1.00/0.33 = 3.03
v_norm = 11.0/5.0 = 2.20
B_threat = (所有8種)/(8×5.0) = 20.5/40 = 0.5125

CT(20) = 0.4×41.67 + 0.25×3.03 + 0.15×2.20 + 0.20×0.5125
       = 16.668 + 0.758 + 0.330 + 0.103
       = 17.859

相對CT(1) = 17.859/0.805 = 22.18倍
```

### CT增長曲線

```
關卡n    CT(n)    相對CT    增長率
1        1.00     1.0×      -
5        2.45     2.5×      +145%
10       5.02     5.0×      +105%
15       9.86     9.9×      +96%
20       22.18    22.2×     +125%
```

**增長模型**（近似）：
```
CT(n) ≈ 0.8e^{0.16n}

R² ≈ 0.97
```

### CT分解分析

**貢獻度**（Stage 20）：
```
HP貢獻:     16.668 / 17.859 = 93.3%  // 主導因素
射速貢獻:   0.758 / 17.859 = 4.2%
速度貢獻:   0.330 / 17.859 = 1.8%
子彈貢獻:   0.103 / 17.859 = 0.6%

結論：HP是主要威脅來源，其他因素提供戰術複雜度
```

---

## 👑 Boss機制

### Boss識別

```
IsBoss(n) = {
    true,  if n ∈ {5, 10, 15, 20}
    false, otherwise
}
```

### Boss特徵

#### 數值特徵
```
Boss關卡通常有：
1. HP大幅增長
2. 獎勵Buff增加（15+: 2個，19+: 3個）
3. 新子彈類型引入
4. 智能瞄準啟用（15+）
```

#### Boss子彈特殊機制

**Stage 5（質變之神）**：
- 首次引入CorruptVoid
- 腐化機制初體驗

**Stage 10（虛空主宰）**：
- 引入CorruptExplosive
- 雙腐化威脅

**Stage 15（深淵狩獵者）**：
- 智能瞄準啟用
- 高級戰術AI

**Stage 20（深淵主宰）**：
- 全子彈類型
- 最高射速
- 最大HP跳躍

### Boss難度乘數

```
Difficulty_Boss(n) = CT(n) × (1 + 0.2·IsBoss(n))

即：Boss關卡難度額外+20%（主觀感受）
```

---

## 📊 敵人數值統計

### 全局統計

```
HP總和：∑HP(n) = 33,920（所有20關）
平均HP：HP_avg = 1,696
HP標準差：σ_HP ≈ 1,450

射速範圍：[0.33, 1.00] 發/秒
速度範圍：[5.0, 11.0] 格/秒
```

### 增長倍數

```
HP增長：5000/120 = 41.67倍
射速增長：1.0/0.33 = 3.03倍
速度增長：11.0/5.0 = 2.20倍
CT增長：22.18倍
```

---

## 📚 交叉引用

**引用**：
- ← [01_Core_Variables.md](01_Core_Variables.md) - 敵人狀態變量定義
- → [02_Combat_Formulas.md](02_Combat_Formulas.md) - 使用敵人HP計算擊殺需求
- → [04_Difficulty_Model.md](04_Difficulty_Model.md) - CT用於難度分析

**代碼源文件**：
- `StageDataSO.cs`: 關卡配置定義
- `Stage_01~20.asset`: 實際數值數據
- `EnemyController.cs`: 第126-269行（射擊和子彈類型邏輯）

---

**文檔狀態**: ✅ 完整  
**新增模型**: ✅ CT模型  
**數據完整性**: ✅ 20關完整數據  
**代碼一致性**: ✅ 100%

